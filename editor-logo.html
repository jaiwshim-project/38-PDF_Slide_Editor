<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로고 원클릭 삭제 - PDF 슬라이드 편집기</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a1a;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ── 툴바 ── */
        .toolbar {
            background: rgba(15, 15, 30, 0.95);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            padding: 0 20px;
            height: 56px;
            display: flex;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(12px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .btn-back {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
            color: #c4c8d8;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            text-decoration: none;
            transition: all 0.2s;
        }
        .btn-back:hover { background: rgba(255,255,255,0.1); }

        .toolbar-title {
            font-size: 15px;
            font-weight: 600;
            color: #e0e0e0;
            flex: 1;
        }
        .toolbar-title span { color: #f87171; }

        .toolbar-actions { display: flex; gap: 8px; }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.06);
            color: #c4c8d8;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { background: rgba(255,255,255,0.1); }

        .btn-danger {
            background: rgba(239,68,68,0.2);
            border-color: rgba(239,68,68,0.3);
            color: #f87171;
        }
        .btn-danger:hover { background: rgba(239,68,68,0.3); }

        .btn-primary {
            background: rgba(59,130,246,0.2);
            border-color: rgba(59,130,246,0.3);
            color: #60a5fa;
        }
        .btn-primary:hover { background: rgba(59,130,246,0.3); }

        .btn-success {
            background: rgba(16,185,129,0.2);
            border-color: rgba(16,185,129,0.3);
            color: #34d399;
        }
        .btn-success:hover { background: rgba(16,185,129,0.3); }

        /* ── 메인 ── */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ── 좌측 설정 패널 ── */
        .settings-panel {
            width: 300px;
            background: rgba(15,15,30,0.6);
            border-right: 1px solid rgba(255,255,255,0.06);
            overflow-y: auto;
            padding: 20px 16px;
            flex-shrink: 0;
        }

        .panel-section {
            margin-bottom: 24px;
        }

        .panel-section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .info-box {
            background: rgba(239,68,68,0.06);
            border: 1px solid rgba(239,68,68,0.12);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 20px;
        }

        .info-box p {
            font-size: 13px;
            color: #e0a0a0;
            line-height: 1.6;
        }

        .info-box strong { color: #f87171; }

        /* 로고 위치 프리셋 */
        .preset-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .preset-btn {
            padding: 10px 8px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            color: #c4c8d8;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .preset-btn:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.15); }
        .preset-btn.active { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); color: #f87171; }

        /* 로고 위치 시각화 */
        .logo-position-visual {
            width: 100%;
            aspect-ratio: 16/9;
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            position: relative;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .logo-marker {
            position: absolute;
            background: rgba(239,68,68,0.3);
            border: 2px solid #f87171;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .logo-marker::after {
            content: 'LOGO';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            font-weight: 700;
            color: #f87171;
        }

        /* 설정 컨트롤 */
        .prop-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .prop-label {
            font-size: 13px;
            color: #9ca3af;
        }

        .prop-input {
            width: 80px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 13px;
            outline: none;
        }
        .prop-input:focus { border-color: rgba(239,68,68,0.5); }

        .prop-value {
            font-size: 12px;
            color: #6b7280;
            min-width: 32px;
            text-align: right;
        }

        .prop-range {
            width: 90px;
            accent-color: #ef4444;
        }

        .prop-color {
            width: 36px;
            height: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            cursor: pointer;
            background: none;
            padding: 2px;
        }

        .full-width-btn {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-remove-all {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            margin-bottom: 10px;
        }
        .btn-remove-all:hover { background: linear-gradient(135deg, #ef4444, #dc2626); box-shadow: 0 4px 20px rgba(239,68,68,0.3); }

        .btn-remove-current {
            background: rgba(239,68,68,0.15);
            border: 1px solid rgba(239,68,68,0.25);
            color: #f87171;
        }
        .btn-remove-current:hover { background: rgba(239,68,68,0.25); }

        /* 진행 상태 */
        .progress-bar-container {
            display: none;
            margin-top: 16px;
        }
        .progress-bar-container.active { display: block; }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.06);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f87171);
            border-radius: 3px;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            font-size: 12px;
            color: #9ca3af;
            text-align: center;
        }

        /* 결과 통계 */
        .result-stats {
            display: none;
            padding: 14px;
            background: rgba(16,185,129,0.06);
            border: 1px solid rgba(16,185,129,0.12);
            border-radius: 10px;
            margin-top: 16px;
        }
        .result-stats.active { display: block; }

        .result-stats p {
            font-size: 13px;
            color: #34d399;
            line-height: 1.6;
        }

        /* ── 중앙 슬라이드 영역 ── */
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .slide-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 12px;
            background: rgba(15,15,30,0.4);
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .slide-nav .btn { padding: 6px 14px; font-size: 12px; }
        .slide-nav-info { font-size: 14px; color: #9ca3af; min-width: 100px; text-align: center; }

        .canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: auto;
            background: radial-gradient(ellipse at 50% 50%, rgba(239,68,68,0.03) 0%, transparent 60%);
        }

        .canvas-wrapper {
            position: relative;
            box-shadow: 0 8px 40px rgba(0,0,0,0.5);
            border-radius: 4px;
            overflow: hidden;
        }

        #slideCanvas {
            display: block;
            max-width: 100%;
            max-height: calc(100vh - 180px);
        }

        /* 로고 하이라이트 오버레이 */
        .logo-highlight {
            position: absolute;
            border: 2px dashed rgba(239,68,68,0.6);
            background: rgba(239,68,68,0.1);
            border-radius: 4px;
            pointer-events: none;
            z-index: 10;
            transition: all 0.3s;
        }

        .logo-highlight.removed {
            border-color: rgba(16,185,129,0.5);
            background: rgba(16,185,129,0.1);
        }

        /* 비교 모드 */
        .compare-slider {
            position: absolute;
            top: 0;
            left: 50%;
            width: 4px;
            height: 100%;
            background: #3b82f6;
            cursor: ew-resize;
            z-index: 20;
            display: none;
        }
        .compare-slider.active { display: block; }

        .compare-slider::after {
            content: '◀ ▶';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #3b82f6;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            white-space: nowrap;
        }

        /* ── 토스트 ── */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 18px;
            background: rgba(30,30,50,0.95);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            font-size: 13px;
            color: #e0e0e0;
            z-index: 500;
            transform: translateX(120%);
            transition: transform 0.3s;
            backdrop-filter: blur(8px);
        }
        .toast.show { transform: translateX(0); }
        .toast.error { border-color: rgba(239,68,68,0.3); }
        .toast.success { border-color: rgba(16,185,129,0.3); }

        /* 커스텀 영역 선택 */
        .custom-area-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            cursor: crosshair;
            z-index: 15;
            display: none;
        }
        .custom-area-overlay.active { display: block; }

        .custom-sel-box {
            position: absolute;
            border: 2px dashed #f87171;
            background: rgba(239,68,68,0.1);
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <a class="btn-back" href="index.html">&#8592; 메뉴</a>
        <div class="toolbar-title"><span>로고 원클릭 삭제</span> &mdash; <span id="currentFileName">-</span></div>
        <div class="toolbar-actions">
            <button class="btn" id="btnCompare">&#9881; 비교 모드</button>
            <button class="btn btn-primary" id="btnDownload">&#8615; 저장</button>
        </div>
    </div>

    <div class="main-layout">
        <!-- 좌측 설정 -->
        <div class="settings-panel">
            <div class="info-box">
                <p><strong>NotebookLM 로고</strong>는 슬라이드의 고정 위치에 나타납니다. 위치를 선택하고 원클릭으로 모든 슬라이드에서 제거하세요.</p>
            </div>

            <div class="panel-section">
                <div class="panel-section-title">로고 위치 프리셋</div>
                <div class="preset-grid">
                    <button class="preset-btn active" data-pos="bottom-right" id="presetBR">우측 하단</button>
                    <button class="preset-btn" data-pos="bottom-left" id="presetBL">좌측 하단</button>
                    <button class="preset-btn" data-pos="top-right" id="presetTR">우측 상단</button>
                    <button class="preset-btn" data-pos="top-left" id="presetTL">좌측 상단</button>
                </div>

                <div class="logo-position-visual" id="positionVisual">
                    <div class="logo-marker" id="logoMarker"></div>
                </div>

                <button class="btn" id="btnCustomArea" style="width:100%; justify-content:center; margin-bottom:12px;">
                    &#9634; 직접 영역 지정
                </button>
            </div>

            <div class="panel-section">
                <div class="panel-section-title">로고 영역 크기</div>
                <div class="prop-row">
                    <span class="prop-label">너비</span>
                    <input type="range" class="prop-range" id="logoWidth" min="30" max="300" value="140">
                    <span class="prop-value" id="logoWidthVal">140px</span>
                </div>
                <div class="prop-row">
                    <span class="prop-label">높이</span>
                    <input type="range" class="prop-range" id="logoHeight" min="15" max="150" value="40">
                    <span class="prop-value" id="logoHeightVal">40px</span>
                </div>
                <div class="prop-row">
                    <span class="prop-label">여백</span>
                    <input type="range" class="prop-range" id="logoMargin" min="0" max="50" value="10">
                    <span class="prop-value" id="logoMarginVal">10px</span>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-section-title">배경 복원 방식</div>
                <div class="prop-row">
                    <span class="prop-label">방식</span>
                    <select class="prop-input" id="restoreMode" style="width:130px">
                        <option value="auto">자동 (색상 분석)</option>
                        <option value="manual">수동 색상 지정</option>
                    </select>
                </div>
                <div class="prop-row" id="manualColorRow" style="display:none">
                    <span class="prop-label">배경색</span>
                    <input type="color" class="prop-color" id="manualBgColor" value="#ffffff">
                </div>
                <div class="prop-row">
                    <span class="prop-label">분석 범위</span>
                    <input type="range" class="prop-range" id="sampleRange" min="5" max="50" value="20">
                    <span class="prop-value" id="sampleRangeVal">20px</span>
                </div>
            </div>

            <div class="panel-section">
                <button class="full-width-btn btn-remove-all" id="btnRemoveAll">
                    &#10005; 모든 슬라이드 로고 삭제
                </button>
                <button class="full-width-btn btn-remove-current" id="btnRemoveCurrent">
                    현재 슬라이드만 삭제
                </button>

                <div class="progress-bar-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p class="progress-text" id="progressText">처리 중...</p>
                </div>

                <div class="result-stats" id="resultStats">
                    <p id="resultText"></p>
                </div>
            </div>
        </div>

        <!-- 중앙 슬라이드 -->
        <div class="canvas-area">
            <div class="slide-nav">
                <button class="btn" id="btnPrev">&#8592; 이전</button>
                <span class="slide-nav-info" id="slideNavInfo">1 / 1</span>
                <button class="btn" id="btnNext">다음 &#8594;</button>
            </div>
            <div class="canvas-container">
                <div class="canvas-wrapper" id="canvasWrapper">
                    <canvas id="slideCanvas"></canvas>
                    <div class="logo-highlight" id="logoHighlight"></div>
                    <div class="custom-area-overlay" id="customAreaOverlay"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ── 상태 ──
        const state = {
            pdfDoc: null,
            currentPage: 1,
            totalPages: 0,
            scale: 1.5,
            logoPosition: 'bottom-right',
            logoWidth: 140,
            logoHeight: 40,
            logoMargin: 10,
            removedPages: new Set(),
            originalCanvasData: {},  // pageNum -> ImageData
            customRect: null,
            isCustomSelecting: false,
            selStart: null
        };

        const canvas = document.getElementById('slideCanvas');
        const ctx = canvas.getContext('2d');

        // ── 초기화 ──
        async function init() {
            const pdfData = sessionStorage.getItem('pdfData');
            const pdfName = sessionStorage.getItem('pdfFileName');
            if (!pdfData) {
                showToast('PDF 파일이 없습니다. 메인으로 돌아가세요.', 'error');
                return;
            }
            document.getElementById('currentFileName').textContent = pdfName || '-';

            const raw = atob(pdfData);
            const uint8 = new Uint8Array(raw.length);
            for (let i = 0; i < raw.length; i++) uint8[i] = raw.charCodeAt(i);

            state.pdfDoc = await pdfjsLib.getDocument({ data: uint8 }).promise;
            state.totalPages = state.pdfDoc.numPages;

            updateSlideNav();
            await renderPage(1);
            updateLogoMarker();
            updateLogoHighlight();
        }

        // ── 페이지 렌더 ──
        async function renderPage(pageNum) {
            state.currentPage = pageNum;
            const page = await state.pdfDoc.getPage(pageNum);
            const vp = page.getViewport({ scale: state.scale });
            canvas.width = vp.width;
            canvas.height = vp.height;
            await page.render({ canvasContext: ctx, viewport: vp }).promise;

            // 원본 저장
            if (!state.originalCanvasData[pageNum]) {
                state.originalCanvasData[pageNum] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }

            // 이미 삭제된 페이지면 다시 적용
            if (state.removedPages.has(pageNum)) {
                removeLogo(pageNum, false);
            }

            updateSlideNav();
            updateLogoHighlight();
        }

        function updateSlideNav() {
            document.getElementById('slideNavInfo').textContent = `${state.currentPage} / ${state.totalPages}`;
        }

        // ── 네비게이션 ──
        document.getElementById('btnPrev').addEventListener('click', () => {
            if (state.currentPage > 1) renderPage(state.currentPage - 1);
        });
        document.getElementById('btnNext').addEventListener('click', () => {
            if (state.currentPage < state.totalPages) renderPage(state.currentPage + 1);
        });

        // ── 로고 위치 계산 ──
        function getLogoRect() {
            if (state.customRect) return state.customRect;

            const w = state.logoWidth * (state.scale);
            const h = state.logoHeight * (state.scale);
            const m = state.logoMargin * (state.scale);

            let x, y;
            switch (state.logoPosition) {
                case 'bottom-right':
                    x = canvas.width - w - m;
                    y = canvas.height - h - m;
                    break;
                case 'bottom-left':
                    x = m;
                    y = canvas.height - h - m;
                    break;
                case 'top-right':
                    x = canvas.width - w - m;
                    y = m;
                    break;
                case 'top-left':
                    x = m;
                    y = m;
                    break;
            }
            return { x: Math.round(x), y: Math.round(y), w: Math.round(w), h: Math.round(h) };
        }

        // ── 로고 하이라이트 ──
        function updateLogoHighlight() {
            const hl = document.getElementById('logoHighlight');
            const rect = getLogoRect();
            const scaleX = canvas.clientWidth / canvas.width;
            const scaleY = canvas.clientHeight / canvas.height;

            hl.style.left = (rect.x * scaleX) + 'px';
            hl.style.top = (rect.y * scaleY) + 'px';
            hl.style.width = (rect.w * scaleX) + 'px';
            hl.style.height = (rect.h * scaleY) + 'px';

            if (state.removedPages.has(state.currentPage)) {
                hl.classList.add('removed');
            } else {
                hl.classList.remove('removed');
            }
        }

        // ── 시각화 마커 ──
        function updateLogoMarker() {
            const marker = document.getElementById('logoMarker');
            const wPct = 30, hPct = 15;
            const mPct = 4;

            switch (state.logoPosition) {
                case 'bottom-right':
                    marker.style.cssText = `right:${mPct}%; bottom:${mPct}%; width:${wPct}%; height:${hPct}%;`;
                    break;
                case 'bottom-left':
                    marker.style.cssText = `left:${mPct}%; bottom:${mPct}%; width:${wPct}%; height:${hPct}%;`;
                    break;
                case 'top-right':
                    marker.style.cssText = `right:${mPct}%; top:${mPct}%; width:${wPct}%; height:${hPct}%;`;
                    break;
                case 'top-left':
                    marker.style.cssText = `left:${mPct}%; top:${mPct}%; width:${wPct}%; height:${hPct}%;`;
                    break;
            }
        }

        // ── 프리셋 버튼 ──
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.logoPosition = btn.dataset.pos;
                state.customRect = null;
                updateLogoMarker();
                updateLogoHighlight();
            });
        });

        // ── 슬라이더 ──
        ['logoWidth', 'logoHeight', 'logoMargin', 'sampleRange'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', () => {
                document.getElementById(id + 'Val').textContent = el.value + 'px';
                if (id !== 'sampleRange') {
                    state[id] = parseInt(el.value);
                    updateLogoHighlight();
                }
            });
        });

        // 복원 방식
        document.getElementById('restoreMode').addEventListener('change', (e) => {
            document.getElementById('manualColorRow').style.display = e.target.value === 'manual' ? 'flex' : 'none';
        });

        // ── 배경색 분석 (로고 제외 영역) ──
        function analyzeBgColor(rect) {
            const mode = document.getElementById('restoreMode').value;
            if (mode === 'manual') {
                return document.getElementById('manualBgColor').value;
            }

            const sampleRange = parseInt(document.getElementById('sampleRange').value) * state.scale;
            const colors = {};

            // 로고 주변 영역 샘플링 (상하좌우)
            const sampleAreas = [
                // 위쪽
                { x: rect.x, y: Math.max(0, rect.y - sampleRange), w: rect.w, h: Math.min(sampleRange, rect.y) },
                // 아래쪽
                { x: rect.x, y: rect.y + rect.h, w: rect.w, h: Math.min(sampleRange, canvas.height - rect.y - rect.h) },
                // 왼쪽
                { x: Math.max(0, rect.x - sampleRange), y: rect.y, w: Math.min(sampleRange, rect.x), h: rect.h },
                // 오른쪽
                { x: rect.x + rect.w, y: rect.y, w: Math.min(sampleRange, canvas.width - rect.x - rect.w), h: rect.h }
            ];

            sampleAreas.forEach(area => {
                if (area.w <= 0 || area.h <= 0) return;
                const imgData = ctx.getImageData(area.x, area.y, area.w, area.h);
                for (let i = 0; i < imgData.data.length; i += 4) {
                    const r = imgData.data[i], g = imgData.data[i+1], b = imgData.data[i+2];
                    const key = `${Math.round(r/4)*4},${Math.round(g/4)*4},${Math.round(b/4)*4}`;
                    colors[key] = (colors[key] || 0) + 1;
                }
            });

            let maxKey = '255,255,255', maxCount = 0;
            for (const [k, v] of Object.entries(colors)) {
                if (v > maxCount) { maxCount = v; maxKey = k; }
            }
            const [r, g, b] = maxKey.split(',').map(Number);
            return `rgb(${r},${g},${b})`;
        }

        // ── 로고 삭제 ──
        function removeLogo(pageNum, save = true) {
            const rect = getLogoRect();
            const bgColor = analyzeBgColor(rect);

            ctx.fillStyle = bgColor;
            ctx.fillRect(rect.x, rect.y, rect.w, rect.h);

            if (save) {
                state.removedPages.add(pageNum);
                updateLogoHighlight();
            }
        }

        // 현재 슬라이드만
        document.getElementById('btnRemoveCurrent').addEventListener('click', async () => {
            // 원본 복원 후 삭제
            if (state.originalCanvasData[state.currentPage]) {
                ctx.putImageData(state.originalCanvasData[state.currentPage], 0, 0);
            }
            removeLogo(state.currentPage);
            showToast(`슬라이드 ${state.currentPage}의 로고가 삭제되었습니다.`, 'success');
        });

        // 모든 슬라이드
        document.getElementById('btnRemoveAll').addEventListener('click', async () => {
            const progress = document.getElementById('progressContainer');
            const fill = document.getElementById('progressFill');
            const text = document.getElementById('progressText');
            progress.classList.add('active');

            for (let i = 1; i <= state.totalPages; i++) {
                fill.style.width = (i / state.totalPages * 100) + '%';
                text.textContent = `${i} / ${state.totalPages} 슬라이드 처리 중...`;

                await renderPage(i);

                // 원본에서 시작
                if (state.originalCanvasData[i]) {
                    ctx.putImageData(state.originalCanvasData[i], 0, 0);
                }
                removeLogo(i);

                await new Promise(r => setTimeout(r, 100));
            }

            fill.style.width = '100%';
            text.textContent = '완료!';

            setTimeout(() => {
                progress.classList.remove('active');
                const stats = document.getElementById('resultStats');
                stats.classList.add('active');
                document.getElementById('resultText').textContent =
                    `${state.totalPages}개 슬라이드에서 로고가 삭제되었습니다.`;
            }, 500);

            // 첫 페이지로 돌아가기
            await renderPage(1);
            showToast('모든 슬라이드의 로고가 삭제되었습니다!', 'success');
        });

        // ── 직접 영역 지정 ──
        const customOverlay = document.getElementById('customAreaOverlay');

        document.getElementById('btnCustomArea').addEventListener('click', () => {
            customOverlay.classList.add('active');
            showToast('슬라이드에서 로고 영역을 드래그하세요');
        });

        customOverlay.addEventListener('mousedown', (e) => {
            state.isCustomSelecting = true;
            const rect = customOverlay.getBoundingClientRect();
            const scaleX = canvas.width / canvas.clientWidth;
            const scaleY = canvas.height / canvas.clientHeight;
            state.selStart = {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY,
                clientX: e.clientX - rect.left,
                clientY: e.clientY - rect.top
            };
        });

        customOverlay.addEventListener('mousemove', (e) => {
            if (!state.isCustomSelecting) return;
            const rect = customOverlay.getBoundingClientRect();
            const cx = e.clientX - rect.left;
            const cy = e.clientY - rect.top;

            customOverlay.querySelectorAll('.custom-sel-box').forEach(b => b.remove());
            const box = document.createElement('div');
            box.className = 'custom-sel-box';
            box.style.left = Math.min(state.selStart.clientX, cx) + 'px';
            box.style.top = Math.min(state.selStart.clientY, cy) + 'px';
            box.style.width = Math.abs(cx - state.selStart.clientX) + 'px';
            box.style.height = Math.abs(cy - state.selStart.clientY) + 'px';
            customOverlay.appendChild(box);
        });

        customOverlay.addEventListener('mouseup', (e) => {
            if (!state.isCustomSelecting) return;
            state.isCustomSelecting = false;
            customOverlay.classList.remove('active');
            customOverlay.querySelectorAll('.custom-sel-box').forEach(b => b.remove());

            const rect = customOverlay.getBoundingClientRect();
            const scaleX = canvas.width / canvas.clientWidth;
            const scaleY = canvas.height / canvas.clientHeight;
            const endX = (e.clientX - rect.left) * scaleX;
            const endY = (e.clientY - rect.top) * scaleY;

            const x = Math.min(state.selStart.x, endX);
            const y = Math.min(state.selStart.y, endY);
            const w = Math.abs(endX - state.selStart.x);
            const h = Math.abs(endY - state.selStart.y);

            if (w > 5 && h > 5) {
                state.customRect = { x: Math.round(x), y: Math.round(y), w: Math.round(w), h: Math.round(h) };
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                updateLogoHighlight();
                showToast('커스텀 로고 영역이 설정되었습니다.', 'success');
            }
        });

        // ── 비교 모드 ──
        document.getElementById('btnCompare').addEventListener('click', async () => {
            if (!state.originalCanvasData[state.currentPage]) return;
            // 원본 보여주기 (토글)
            const origData = state.originalCanvasData[state.currentPage];
            if (document.getElementById('btnCompare').dataset.showing === 'original') {
                await renderPage(state.currentPage);
                document.getElementById('btnCompare').textContent = '&#9881; 비교 모드';
                document.getElementById('btnCompare').dataset.showing = '';
            } else {
                ctx.putImageData(origData, 0, 0);
                document.getElementById('btnCompare').innerHTML = '&#8634; 편집본 보기';
                document.getElementById('btnCompare').dataset.showing = 'original';
                showToast('원본 이미지를 표시합니다');
            }
        });

        // ── 저장 ──
        document.getElementById('btnDownload').addEventListener('click', async () => {
            for (let i = 1; i <= state.totalPages; i++) {
                if (state.removedPages.has(i)) {
                    await renderPage(i);
                    const link = document.createElement('a');
                    link.download = `slide_${i}_no_logo.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    await new Promise(r => setTimeout(r, 300));
                }
            }
            if (state.removedPages.size === 0) {
                // 편집 없으면 현재만 저장
                const link = document.createElement('a');
                link.download = `slide_${state.currentPage}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
            await renderPage(state.currentPage);
            showToast('저장 완료!', 'success');
        });

        // ── 유틸 ──
        function showToast(msg, type = '') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast ' + type;
            setTimeout(() => t.classList.add('show'), 10);
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // ── 시작 ──
        init();
    </script>
</body>
</html>
